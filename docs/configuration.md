# East configuration

The `east` tool provides a way to specify the project-specific configuration. The configuration is
done with an `east.yml` file, which needs to be placed in the _root directory_ of the repository.

Currently, the configuration is required for:

- specifying which files should be copied when using `east pack`,
- specifying where to place VERSION files when using `east util version`.

The `east.yml` file is optional; Users do not need to create it in order to use `east`. However in
that case, the above functionalities will not work.

This document describes the expected contents of `east.yml` and how to specify binary assets for the
`east pack` command.

## General structure of the configuration file

`east.yml` contains two main keys:

- `pack` - lists which artifacts to be copied when using `east pack` for all or for specific
  applications and samples.
- `version` - lists directories into which `east` will place VERSION files when using
  `east util version` command. See `east util version --help` for more details.

<!-- prettier-ignore -->
> [!NOTE]
> The `app` and `samples` yaml keys are deprecated.
> See the [old documentation](configuration_old.md) for their use.

Below is an example of `east.yml` that can be copied into a project and modified:

```yaml
pack:
  artifacts:
    - $APP_DIR/zephyr/zephyr.hex
    - $APP_DIR/zephyr/zephyr.bin
    - merged.hex
  projects:
    - name: sample.blinky
      overwrite_artifacts:
        - $APP_DIR/zephyr/zephyr.hex
  extra:
    - scripts/some_script/some_script.sh
    - scripts/generated_extra_stuff.zip

version:
  paths:
    - app/
```

## Pack

Packing is the process of copying the build artifacts into a specific directory, usually for the
purpose of creating a release. All the files are also renamed to include the version tag, which is
automatically determined by `git` or provided via the `--tag` option to the `east pack` command.

The `east pack` command uses the `pack` key from the `east.yml` file to determine which files to
copy from build directories generated by
[Twister](https://docs.zephyrproject.org/latest/develop/test/twister.html).

To understand how `east pack` works, it is important to know how to use Twister and how to specify
build targets with `sample.yaml` files. Each target built by Twister is called a **test-suite** by
the twister documentation, and will also be referred to as such in this document. For more details
on how to use Twister to generate build artifacts, see our
[Zephyr template repo](https://github.com/IRNAS/irnas-zephyr-template) and read the docs there.

The `pack` key in `east.yml` specifies which files to copy for each of the test-suites. It has the
following sub-keys:

- `pack.artifacts` - a list of files to copy for all test-suites.
- `pack.projects` - a list of specific test-suites with additional configuration. This allows you to
  overwrite the default artifacts or specify additional artifacts for specific test-suites. Each
  project in the list has the following:
  - `name` - the name of the test-suite. This **must match** the name of the test-suite as defined
    in the `sample.yaml` file.
  - `artifacts` - a list of files to copy for this specific test-suite in addition to files in
    `pack.artifacts`.
  - `overwrite_artifacts` - a list of files to copy for this specific test-suite, overwriting the
    default artifacts specified in `pack.artifacts`. When using this, do not use `artifacts`.
- `pack.extra` - a list of additional files to copy that are not part of the twister output, but are
  created by other means.

### File paths and the `$APP_DIR` variable

The files specified in the `artifacts` and `projects` keys are **relative** the build folder of the
test-suite (the build folders generated by Twister are the same as the ones generated by
`west build`).

Thus, specifying `merged.hex` means that `build/merged.hex` must exist and will be copied.

The build folder contains sub-folders with different names, depending on what is being built:

- When using sysbuild, the application files are always placed in a sub-folder named the same as the
  folder where the base `CMakeLists.txt` is located. For example, if the base `CMakeLists.txt` is in
  the `app/` folder, the application files will be in `build/app/`.
- When not using sysbuild, the application files are placed directly in `build/`.

Whether sysbuild is enabled and what the folder is named is different for each test-suite. For ease
of use, the `$APP_DIR` variable is used to refer to the application files build directory.

For example:

- if we have a sysbuild application in the `app/` folder, the `$APP_DIR` variable will be `app`.
- if we have a sysbuild application in the `samples/blinky/` folder, the `$APP_DIR` variable will be
  `blinky`.
- if we have a non-sysbuild application in the `app/` folder, the `$APP_DIR` variable will be `.`.

This is useful when specifying files in the `artifacts` folder, since they are common for all
test-suites, which have differently named sub-folders in their build folders.

### The destination of the copied files

All the specified files are copied to the `package` folder in the root of the project (or some other
folder as specified by the `--pack-path` option).

Extra files are copied to `package/extra`.

Files from twister are copied to `package/<test-suite>/<board>/` for each test-suite and board
combination (as specified in the `sample.yaml` files).

### File renaming and versioning

When copying files, `east pack` will rename them to include the version tag, and information about
the test-suite and board. The tag is either provided with the `--tag` option or is determined from
the current git tag (`git describe --tags --always --long --dirty=+`).

The files are renamed according to the file rename scheme as specified:

- For [twister artifacts](../src/east/modules/artifact.py#L151). Simply put, the files will be
  renamed to `<test-suite>-<filename>-<version>.<ext>`.
- For [extra artifacts](../src/east/modules/artifact.py#L264). Simply put, the files will be renamed
  to `<filename>-<version>.<ext>`.

### Zip file creation

After the files are copied, `east pack` will create zip files:

- For each test-suite, a zip file will be created in the `package` folder with the name
  `<test-suite>-<version>.zip`.
- If there are extra files, `extra-<version>.zip` will be created.

These zip files are intended to be used for releases.

### Example

We have an `app`, a `sample/blinky` and a `scripts/some_script/some_script.sh` file we would like to
pack. We build for 2 versions of our custom board and the `nrf52840DK`.

After running twister, we get the following `twister-out` folder structure:

```text
> tree twister-out -L 4
twister-out
├── custom_board@1.0.0_nrf52840
│   └── zephyr
│       └── app
│           ├── app.debug
│           ├── app.prod
│           ├── app.rtt
│           └── app.uart
├── custom_board@1.4.0_nrf52840
│   └── zephyr
│       ├── app
│       │   ├── app.debug
│       │   ├── app.prod
│       │   ├── app.rtt
│       │   └── app.uart
│       └── samples
│           └── blinky
├── nrf52840dk_nrf52840
│   └── zephyr
│       ├── app
│       │   ├── app.debug
│       │   ├── app.prod
│       │   ├── app.rtt
│       │   └── app.uart
│       └── samples
│           └── blinky
├── testplan.json
├── twister.json
├── twister.log
├── twister_report.xml
├── twister_suite_report.xml
└── twister.xml
```

Our `east.yml` file looks like this:

```yaml
pack:
  artifacts:
    - $APP_DIR/zephyr/zephyr.hex
    - $APP_DIR/zephyr/zephyr.bin
    - merged.hex
  projects:
    - name: sample.blinky
      overwrite_artifacts:
        - $APP_DIR/zephyr/zephyr.hex
  extra:
    - scripts/update_docker_versions.sh
    - scripts/renode/install.sh
```

When we run `east pack`, the following `package` folder is generated:

```text
> east pack --tag v1.0.0
> tree package -L 3
package
├── app.debug
│   ├── custom_board@1.0.0_nrf52840
│   │   ├── app.debug-merged-v1.0.0.hex
│   │   ├── app.debug-zephyr-v1.0.0.bin
│   │   └── app.debug-zephyr-v1.0.0.hex
│   ├── custom_board@1.4.0_nrf52840
│   │   ├── app.debug-merged-v1.0.0.hex
│   │   ├── app.debug-zephyr-v1.0.0.bin
│   │   └── app.debug-zephyr-v1.0.0.hex
│   └── nrf52840dk_nrf52840
│       ├── app.debug-merged-v1.0.0.hex
│       ├── app.debug-zephyr-v1.0.0.bin
│       └── app.debug-zephyr-v1.0.0.hex
├── app.debug-v1.0.0.zip
├── app.prod
│   ├── custom_board@1.0.0_nrf52840
│   │   ├── app.prod-merged-v1.0.0.hex
│   │   ├── app.prod-zephyr-v1.0.0.bin
│   │   └── app.prod-zephyr-v1.0.0.hex
│   ├── custom_board@1.4.0_nrf52840
│   │   ├── app.prod-merged-v1.0.0.hex
│   │   ├── app.prod-zephyr-v1.0.0.bin
│   │   └── app.prod-zephyr-v1.0.0.hex
│   └── nrf52840dk_nrf52840
│       ├── app.prod-merged-v1.0.0.hex
│       ├── app.prod-zephyr-v1.0.0.bin
│       └── app.prod-zephyr-v1.0.0.hex
├── app.prod-v1.0.0.zip
├── app.rtt
│   ├── custom_board@1.0.0_nrf52840
│   │   ├── app.rtt-merged-v1.0.0.hex
│   │   ├── app.rtt-zephyr-v1.0.0.bin
│   │   └── app.rtt-zephyr-v1.0.0.hex
│   ├── custom_board@1.4.0_nrf52840
│   │   ├── app.rtt-merged-v1.0.0.hex
│   │   ├── app.rtt-zephyr-v1.0.0.bin
│   │   └── app.rtt-zephyr-v1.0.0.hex
│   └── nrf52840dk_nrf52840
│       ├── app.rtt-merged-v1.0.0.hex
│       ├── app.rtt-zephyr-v1.0.0.bin
│       └── app.rtt-zephyr-v1.0.0.hex
├── app.rtt-v1.0.0.zip
├── app.uart
│   ├── custom_board@1.0.0_nrf52840
│   │   ├── app.uart-merged-v1.0.0.hex
│   │   ├── app.uart-zephyr-v1.0.0.bin
│   │   └── app.uart-zephyr-v1.0.0.hex
│   ├── custom_board@1.4.0_nrf52840
│   │   ├── app.uart-merged-v1.0.0.hex
│   │   ├── app.uart-zephyr-v1.0.0.bin
│   │   └── app.uart-zephyr-v1.0.0.hex
│   └── nrf52840dk_nrf52840
│       ├── app.uart-merged-v1.0.0.hex
│       ├── app.uart-zephyr-v1.0.0.bin
│       └── app.uart-zephyr-v1.0.0.hex
├── app.uart-v1.0.0.zip
├── extra
│   ├── install-v1.0.0.sh
│   └── update_docker_versions-v1.0.0.sh
├── extra-v1.0.0.zip
├── sample.blinky
│   ├── custom_board@1.4.0_nrf52840
│   │   └── sample.blinky-zephyr-v1.0.0.hex
│   └── nrf52840dk_nrf52840
│       └── sample.blinky-zephyr-v1.0.0.hex
└── sample.blinky-v1.0.0.zip
```
